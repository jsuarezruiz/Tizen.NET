<Project>

  <ItemGroup>
    <PackageReference Include="Microsoft.DotNet.Arcade.Sdk" Version="$(MicrosoftDotNetBuildTasksFeedPackageVersion)" PrivateAssets="all" GeneratePathProperty="true" />
  </ItemGroup>

  <Import Project="..\src\Samsung.Tizen.Build.PrepTasks\PrepTasks.targets" />
  <Import Project="Sdk.props" Sdk="Microsoft.DotNet.SharedFramework.Sdk" Version="$(MicrosoftDotNetBuildTasksFeedPackageVersion)" />

  <PropertyGroup>
    <_DefaultTargetDotnetPath>$(_ProjectRootDirectory)\tools\dotnet\</_DefaultTargetDotnetPath>
    <_TargetDotnetPath Condition="'$(TargetDotnetPath)' != ''">$(TargetDotnetPath)</_TargetDotnetPath>
    <_TargetDotnetPath Condition="'$(TargetDotnetPath)' == ''">$(_DefaultTargetDotnetPath)</_TargetDotnetPath>
    <_TargetDotnetPath>$([MSBuild]::EnsureTrailingSlash($(_TargetDotnetPath)))</_TargetDotnetPath>
  </PropertyGroup>

  <PropertyGroup>
    <NuGetLicense Condition=" '$(NuGetLicense)' == '' ">..\LICENSE</NuGetLicense>
    <PackageLicenseFile>LICENSE</PackageLicenseFile>
  </PropertyGroup>

  <Target Name="_GetPackageVersion">
    <Error Condition="'$(TizenPackVersion)' == ''" Text="TizenPackVersion property is not set." />
    <PropertyGroup>
      <PackageVersion Condition="'$(TizenVersionHash)' != ''">$(TizenPackVersion)+sha.$(TizenVersionHash)</PackageVersion>
      <PackageVersion Condition="'$(TizenVersionHash)' == ''">$(TizenPackVersion)</PackageVersion>
    </PropertyGroup>
  </Target>

  <!-- https://github.com/xamarin/xamarin-android/blob/c703fa9431894132619e50e04a04eb3543b1f62f/build-tools/create-packs/Directory.Build.targets#L27 -->
  <Target Name="_GetLicense">
    <!-- NuGet doesn't have a way to change the filename of License.txt, so copy it -->
    <Copy
        SourceFiles="$(NuGetLicense)"
        DestinationFiles="$(IntermediateOutputPath)$(PackageLicenseFile)"
        SkipUnchangedFiles="true"
    />
    <ItemGroup>
      <_PackageFiles Include="$(IntermediateOutputPath)$(PackageLicenseFile)" PackagePath="\" />
    </ItemGroup>
  </Target>

  <!-- https://github.com/xamarin/xamarin-android/blob/6ec79a3533a40be3ba3147bc6a72498e7287981a/build-tools/create-packs/Directory.Build.targets#L74 -->
  <Target Name="InstallWorkloadPacks" DependsOnTargets="UninstallWorkloadPacks" >
    <ItemGroup>
      <_WLManifest Include="$(OutputPath)Samsung.NET.Sdk.Tizen.Manifest-*.nupkg" />
    </ItemGroup>
    <PropertyGroup>
      <_WLPackVersion>@(_WLManifest->'%(Filename)'->Replace('Samsung.NET.Sdk.Tizen.Manifest-$(DotNetPreviewVersionBand).', ''))</_WLPackVersion>
      <_SdkManifestsDirectory>$(_TargetDotnetPath)sdk-manifests\$(DotNetPreviewVersionBand)\</_SdkManifestsDirectory>
    </PropertyGroup>
    <Unzip
        SourceFiles="@(_WLManifest)"
        DestinationFolder="$(_SdkManifestsDirectory)temp"
    />
    
    <!-- Install manifest package first. -->
    <ItemGroup>
      <_WLManifestFiles Include="$(_SdkManifestsDirectory)temp\LICENSE" />
      <_WLManifestFiles Include="$(_SdkManifestsDirectory)temp\data\*" />
    </ItemGroup>
    <Move SourceFiles="@(_WLManifestFiles)" DestinationFolder="$(_SdkManifestsDirectory)samsung.net.sdk.tizen" />
    <RemoveDir Directories="$(_SdkManifestsDirectory)temp\" />
    
    <!-- dotnet workload install tizen -->
    <PropertyGroup>
      <_NuGetConfig>$(_ProjectRootDirectory)\.tmp\NuGet.config</_NuGetConfig>
      <_NuGetContent>
<![CDATA[
<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <packageSources>
    <clear />
    <add key="local" value="$(OutputPath)" />
  </packageSources>
</configuration>
]]>
      </_NuGetContent>
    </PropertyGroup>
    <WriteLinesToFile File="$(_NuGetConfig)" Lines="$(_NuGetContent)" Overwrite="true" />
    <Exec
        WorkingDirectory="$(_ProjectRootDirectory)\.tmp\"
        Command="&quot;$(_TargetDotnetPath)dotnet&quot; workload install tizen --skip-manifest-update"
    />
  </Target>

  <Target Name="UninstallWorkloadPacks" >
    <ItemGroup>
      <_DirectoriesToRemove Include="$(_TargetDotnetPath)sdk-manifests\$(DotNetPreviewVersionBand)\samsung.net.sdk.tizen\" />
      <_DirectoriesToRemove Include="$(_TargetDotnetPath)packs\Samsung.Tizen.Sdk\" />
      <_DirectoriesToRemove Include="$(_TargetDotnetPath)packs\Samsung.Tizen.Ref\" />
      <_FilesToRemove Include="$(_TargetDotnetPath)template-packs\samsung.tizen.templates.*.nupkg" />
    </ItemGroup>
    <RemoveDir Directories="@(_DirectoriesToRemove)" />
    <Delete Files="@(_FilesToRemove)" />
  </Target>

</Project>